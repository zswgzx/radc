# Generated by Neurodocker version 0.6.0
#     https://github.com/kaczmarj/neurodocker

FROM ubuntu:18.04

ARG DEBIAN_FRONTEND="noninteractive"

RUN apt-get update -qq \
    && apt-get install -yq --no-install-recommends \
	   ca-certificates \
           curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && chmod 777 /opt && chmod a+s /opt

ENV ANTSPATH="/opt/ants-2.3.2" \
    PATH="/opt/ants-2.3.2/bin:$PATH" \
    ANTS_RANDOM_SEED=0
RUN echo "Downloading ANTs ..." \
    && mkdir -p /opt/ants-2.3.2 \
    && curl -sSL --retry 3 https://dl.dropbox.com/s/hrm530kcqe3zo68/ants-Linux-centos6_x86_64-v2.3.2.tar.gz \
    | tar -xz -C /opt/ants-2.3.2 --strip-components 1 \
    && rm -f $ANTSPATH/bin/[cisw]* $ANTSPATH/bin/ants[BJLMNSTU]* $ANTSPATH/bin/[ACDEFGIKLMNPRSTW]* $ANTSPATH/lib/libl_[ACDEFGIKLMNPRSTWcis]* $ANTSPATH/lib/libl_ants[JLMSTU]* \
    && find $ANTSPATH/bin -name "*.sh" -delete \
    && find $ANTSPATH/bin -name "*.R" -delete

COPY 'icbm2009c-asym-t2-masked-forQSM.nii.gz' '/template/'

RUN echo '#!/usr/bin/env bash' >> /opt/antsReg.sh \
    && echo 'set -e' >> /opt/antsReg.sh \
    && echo 'antsRegistration -d 3 -o [/input/$1-,/input/$1-warped.nii.gz] -n Linear -w [0.005,0.995] -u 0 -r [/template/icbm2009c-asym-t2-masked-forQSM.nii.gz,/input/$1.nii.gz,1] -t Rigid[0.1] -m MI[/template/icbm2009c-asym-t2-masked-forQSM.nii.gz,/input/$1.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-6,10] -f 8x4x2x1 -s 3x2x1x0vox -t Affine[0.1] -m MI[/template/icbm2009c-asym-t2-masked-forQSM.nii.gz,/input/$1.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-6,10] -f 8x4x2x1 -s 3x2x1x0vox -t SyN[0.25] -m CC[/template/icbm2009c-asym-t2-masked-forQSM.nii.gz,/input/$1.nii.gz,1,4] -c [100x70x50x20,1e-6,10] -f 8x4x2x1 -s 3x2x1x0vox' >> /opt/antsReg.sh \
    && echo 'antsApplyTransforms -d 3 -i /input/$1-mask.nii.gz -o /input/$1-mask-warped.nii.gz -r /template/icbm2009c-asym-t2-masked-forQSM.nii.gz -t /input/$1-1Warp.nii.gz -t /input/$1-0GenericAffine.mat -n NearestNeighbor' >> /opt/antsReg.sh \ 
    && echo 'antsApplyTransforms -d 3 -i /input/$1-t2.nii.gz -o /input/$1-t2-warped.nii.gz -r /template/icbm2009c-asym-t2-masked-forQSM.nii.gz -t /input/$1-1Warp.nii.gz -t /input/$1-0GenericAffine.mat' >> /opt/antsReg.sh \
    && chmod a+x /opt/antsReg.sh

ENTRYPOINT ["/opt/antsReg.sh"]
